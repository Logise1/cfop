<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenador de Algoritmos CFOP</title>
    
    <!-- 1. Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Carga de Cubing.js (twisty-player) como módulo -->
    <script type="module" src="https://cdn.cubing.net/v0/js/cubing/twisty"></script>
    
    <style>
        /* Fondo con gradiente sutil para un look más premium */
        body {
            background-color: #0a0e1a; /* Un azul casi negro */
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 20px 20px;
        }

        /* Estilo para que el twisty-player se vea nítido */
        twisty-player {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            border-radius: 0.5rem; /* rounded-md */
        }
        
        /* Clases de utilidad para el JS */
        .tab-btn-base {
             padding: 0.75rem 1.5rem; /* Más padding */
             border-radius: 0.5rem; /* rounded-lg */
             font-weight: 600; /* font-semibold */
             transition: all 0.2s ease-in-out;
             outline: none;
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 0.5rem;
             border: 2px solid transparent; /* Borde para el estado focus */
             /* Desactivar botón */
             disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none;
        }
        .tab-btn-base:focus-visible {
            border-color: #38bdf8; /* Borde cyan en focus */
        }
        
        .tab-btn-active {
            background-image: linear-gradient(to right, #06b6d4, #3b82f6); /* bg-gradient-to-r from-cyan-500 to-blue-500 */
            color: white;
            box-shadow: 0 10px 15px -3px rgba(6, 182, 212, 0.3), 0 4px 6px -4px rgba(6, 182, 212, 0.2); /* Sombra de color */
        }
        .tab-btn-active:disabled {
             background-image: none;
             background-color: #374151; /* bg-gray-700 */
             color: #6b7280; /* text-gray-500 */
        }
        .tab-btn-inactive {
            background-color: #1f2937; /* bg-gray-800 */
            color: #d1d5db; /* text-gray-300 */
        }
        .tab-btn-inactive:hover:not(:disabled) {
            background-color: #374151; /* hover:bg-gray-700 */
        }

        /* Estilos del Cronómetro */
        #timer-display {
            font-family: 'Roboto Mono', monospace, sans-serif;
            transition: color 0.1s ease-in-out;
            user-select: none; /* Evitar seleccionar el texto del timer */
        }

        /* Animación para el modal */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .modal-scale-in {
            animation: scaleIn 0.3s ease-out;
        }
        
        /* (NUEVO) Overlay para forzar modo horizontal en móvil en la vista de timer */
        #mobile-orientation-overlay {
            display: none; /* Oculto por defecto */
        }
        @media (max-width: 768px) and (orientation: portrait) {
            /* Solo se muestra si el body tiene la clase (inyectada por JS) Y está en portrait */
            body.timer-view-active #mobile-orientation-overlay {
                display: flex;
            }
            /* Ocultar el timer real */
            body.timer-view-active #timer-view {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased min-h-screen">

    <!-- (NUEVO) MODAL DE ORIENTACIÓN -->
    <div id="mobile-orientation-overlay" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50">
        <div class="text-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-24 h-24 mx-auto mb-4 animate-pulse">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-1.07-4.089a5 5 0 00-8.573-2.733l-1.558 1.558a5 5 0 002.733 8.573l4.09 1.07 4.09-1.07a5 5 0 002.733-8.573L16.6 13.684c-.531.031-.998.063-1.458.11l-1.458-.11z" />
            </svg>
            <h2 class="text-3xl font-bold mb-4">Gira tu dispositivo</h2>
            <p class="text-lg text-gray-300">Por favor, rota tu móvil a modo horizontal para usar el cronómetro.</p>
        </div>
    </div>

    <!-- 1. MODAL DE CONFIGURACIÓN INICIAL (Rediseñado) -->
    <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50 hidden modal-fade-in">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full text-center border border-gray-700 modal-scale-in">
            
            <!-- Visor en el modal para "enganchar" -->
            <div class="w-48 h-48 mx-auto mb-6">
                 <twisty-player
                    alg="R U R' U' R' F R F'"
                    setup="y'"
                    control-panel="none" <!-- Mantenemos "none" en el modal de bienvenida -->
                    visualization="2D"
                    experimental-stickering="PLL"
                    background="none"
                ></twisty-player>
            </div>
            
            <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-4">¡Es hora de ser más rápido!</h2>
            <p class="text-lg text-gray-300 mb-8">¡Bienvenido, Speedcuber! Elige tu punto de partida y destruye tus récords. ¿Con qué set empezamos?</p>
            
            <!-- Botones mejorados -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <button data-order="f2l,oll,pll" class="setup-btn tab-btn-base tab-btn-active">
                    F2L
                </button>
                <button data-order="oll,pll,f2l" class="setup-btn tab-btn-base tab-btn-inactive">
                    OLL
                </button>
                <button data-order="pll,f2l,oll" class="setup-btn tab-btn-base tab-btn-inactive">
                    PLL
                </button>
            </div>
        </div>
    </div>

    <!-- 2. CONTENIDO PRINCIPAL DE LA APP -->
    <div class="container max-w-7xl mx-auto p-4 sm:p-8">
        
        <!-- Título y Navegación Principal (Con iconos) -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                Entrenador CFOP
            </h1>
            <!-- NAVEGACIÓN ACTUALIZADA -->
            <nav class="flex justify-center flex-wrap gap-4 mt-8">
                <button id="nav-daily" class="tab-btn-base"></button> <!-- Contenido inyectado por JS -->
                <button id="nav-browse" class="tab-btn-base"></button> <!-- Contenido inyectado por JS -->
                <button id="nav-timer" class="tab-btn-base"></button> <!-- NUEVO: Cronómetro -->
            </nav>
        </header>

        <!-- 3. VISTA: ENTRENADOR DIARIO -->
        <main id="daily-view">
            <!-- Dashboard de Progreso -->
            <section id="dashboard-stats" class="mb-12 p-8 bg-gray-800 rounded-2xl shadow-xl border border-gray-700">
                <!-- El contenido del dashboard se inyectará aquí -->
            </section>

            <h2 class="text-3xl font-semibold text-center text-gray-200 mb-8">Tu Misión de Hoy</h2>
            <div id="daily-algs-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-5xl mx-auto">
                <!-- Los 2 algoritmos del día se cargarán aquí -->
                <p id="daily-loading" class="text-center text-xl text-gray-400 col-span-full">Cargando tu misión...</p>
            </div>
        </main>

        <!-- 4. VISTA: EXPLORAR TODO -->
        <main id="browse-view" class="hidden">
            <!-- Navegación de Pestañas (Explorar) -->
            <nav class="flex justify-center gap-4 mb-8">
                <button id="btn-browse-f2l" class="tab-btn-browse tab-btn-base" data-category="f2l">F2L</button>
                <button id="btn-browse-oll" class="tab-btn-browse tab-btn-base" data-category="oll">OLL</button>
                <button id="btn-browse-pll" class="tab-btn-browse tab-btn-base" data-category="pll">PLL</button>
            </nav>

            <!-- Contenedor para los Algoritmos (Explorar) -->
            <div id="browse-content-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <p id="browse-loading" class="text-center text-2xl font-semibold text-gray-400 col-span-full">Selecciona una categoría para empezar.</p>
            </div>
        </main>
        
        <!-- 5. (NUEVO) VISTA: CRONÓMETRO -->
        <main id="timer-view" class="hidden">
            <div class="flex flex-col lg:flex-row gap-8">
                
                <!-- Columna Izquierda: Timer (ACTUALIZADA con áreas táctiles) -->
                <div class="lg:w-3/5 w-full flex relative items-center justify-center bg-gray-800 rounded-2xl border border-gray-700 p-8" style="min-height: 400px; touch-action: none;">
                    
                    <!-- (NUEVO) Áreas táctiles/click -->
                    <div id="btn-timer-left" class="absolute left-0 top-0 w-1/2 h-full cursor-pointer z-20"></div>
                    <div id="btn-timer-right" class="absolute right-0 top-0 w-1/2 h-full cursor-pointer z-20"></div>
                    
                    <div id="timer-display" class="text-9xl font-bold text-gray-100 z-10">
                        0.00
                    </div>
                </div>
                
                <!-- Columna Derecha: Stats -->
                <div class="lg:w-2/5 w-full bg-gray-800 rounded-2xl border border-gray-700 p-8">
                    <h2 class="text-3xl font-bold text-cyan-400 mb-6">Sesión</h2>
                    
                    <!-- Estadísticas -->
                    <div id="stats-container" class="grid grid-cols-2 gap-4 mb-6">
                        <!-- Stats se inyectan aquí -->
                    </div>
                    
                    <!-- Lista de Tiempos -->
                    <h3 class="text-xl font-semibold text-gray-200 mb-2">Tiempos</h3>
                    <div id="solves-list-container" class="h-64 overflow-y-auto bg-gray-900 rounded-lg p-4 text-gray-300 font-mono text-lg flex flex-wrap gap-x-4">
                        <!-- Tiempos se inyectan aquí -->
                    </div>
                    
                    <!-- Botón de Borrar -->
                    <button id="delete-solves-btn" class="w-full mt-6 tab-btn-base bg-red-600 hover:bg-red-500 text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.548 0A48.108 48.108 0 015.8 5.392m7.708 0a48.108 48.108 0 01-7.708 0z" />
                        </svg>
                        Borrar Sesión
                    </button>
                </div>
            </div>
        </main>

    </div>

    <!-- Script principal de la aplicación -->
    <script type="module">
        // --- CONSTANTES ---
        const JSON_URL = 'https://logise1.github.io/cfop/cfop.json';
        const LS_KEYS = {
            SETUP: 'cfop_user_setup_v3',
            ORDER: 'cfop_learn_order_v3',
            LEARNED: 'cfop_learned_algs_v3',
            DAILY: 'cfop_daily_algs_v3',
            LAST_VISIT: 'cfop_last_visit_date_v3',
            SOLVES: 'cfop_solves_v1' // Para el cronómetro
        };
        
        // Iconos SVG para los botones (de Heroicons)
        const ICON_CALENDAR = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg> <span>Diario</span>`;
        const ICON_GRID = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25A2.25 2.25 0 0113.5 8.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg> <span>Explorar</span>`;
        const ICON_TIMER = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span>Cronómetro</span>`;
        const ICON_CHECK = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg> <span>¡Aprendido!</span>`;
        const ICON_KNOW_IT = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> ¡Ya lo sé!`;

        // --- REFERENCIAS DEL DOM ---
        const setupModal = document.getElementById('setup-modal');
        const dailyView = document.getElementById('daily-view');
        const browseView = document.getElementById('browse-view');
        const timerView = document.getElementById('timer-view'); 
        const navDaily = document.getElementById('nav-daily');
        const navBrowse = document.getElementById('nav-browse');
        const navTimer = document.getElementById('nav-timer'); 
        const dashboardStats = document.getElementById('dashboard-stats'); 
        const dailyAlgsContainer = document.getElementById('daily-algs-container');
        const dailyLoading = document.getElementById('daily-loading');
        const browseContentContainer = document.getElementById('browse-content-container');
        const browseLoading = document.getElementById('browse-loading');
        const browseTabs = document.querySelectorAll('.tab-btn-browse');
        const setupButtons = document.querySelectorAll('.setup-btn');
        // (NUEVO) Refs del Timer
        const timerDisplay = document.getElementById('timer-display');
        const solvesListContainer = document.getElementById('solves-list-container');
        const statsContainer = document.getElementById('stats-container');
        const deleteSolvesBtn = document.getElementById('delete-solves-btn');
        const btnTimerLeft = document.getElementById('btn-timer-left');
        const btnTimerRight = document.getElementById('btn-timer-right');

        // --- ESTADO DE LA APLICACIÓN ---
        let allData = {};
        let totalAlgs = 0; 
        let userLearnOrder = [];
        let learnedAlgs = [];
        let currentBrowseCategory = 'f2l';
        let currentView = 'daily'; // Para controlar los key listeners
        
        // (NUEVO) Estado del Timer
        let timerInterval;
        let timerStartTime;
        let timerRunning = false;
        let timerReady = false;
        let solvesList = [];
        let leftThumbDown = false;
        let rightThumbDown = false;

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', fetchData);
        
        // Inyectar iconos en botones de nav
        navDaily.innerHTML = ICON_CALENDAR;
        navBrowse.innerHTML = ICON_GRID;
        navTimer.innerHTML = ICON_TIMER; 

        /**
         * 1. Carga los datos del JSON y luego inicia la app
         */
        async function fetchData() {
            try {
                const response = await fetch(JSON_URL);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                allData = await response.json();
                
                // Calcular total de algoritmos
                totalAlgs = (allData.f2l?.length || 0) + (allData.oll?.length || 0) + (allData.pll?.length || 0);
                
                // Una vez cargados los datos, revisa la configuración del usuario
                checkUserSetup();
                
            } catch (error) {
                console.error('Error al cargar el JSON:', error);
                dailyLoading.textContent = 'Error fatal al cargar algoritmos. Revisa la consola.';
                browseLoading.textContent = 'Error fatal al cargar algoritmos. Revisa la consola.';
            }
        }

        /**
         * 2. Revisa si el usuario ya hizo la configuración inicial
         */
        function checkUserSetup() {
            const setupDone = localStorage.getItem(LS_KEYS.SETUP) === 'true';

            // Listeners de navegación principal
            navDaily.addEventListener('click', showDailyView);
            navBrowse.addEventListener('click', showBrowseView);
            navTimer.addEventListener('click', showTimerView); 
            
            // (NUEVO) Listeners globales para el timer
            window.addEventListener('keydown', handleTimerKeydown);
            window.addEventListener('keyup', handleTimerKeyup);

            if (setupDone) {
                // El usuario ya está configurado, cargar datos y mostrar vista diaria
                loadUserData();
                initDailyView();
            } else {
                // Es la primera vez, mostrar modal de configuración
                setupModal.classList.remove('hidden');
                setupButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const order = button.dataset.order.split(',');
                        saveUserSetup(order);
                    });
                });
            }
        }

        /**
         * 3. Guarda la configuración inicial del usuario
         */
        function saveUserSetup(order) {
            localStorage.setItem(LS_KEYS.SETUP, 'true');
            localStorage.setItem(LS_KEYS.ORDER, JSON.stringify(order));
            localStorage.setItem(LS_KEYS.LEARNED, JSON.stringify([])); // Empezar con 0 aprendidos
            
            loadUserData();
            initDailyView();
            
            // Ocultar modal
            setupModal.classList.add('hidden');
        }

        /**
         * 4. Carga los datos del usuario desde localStorage
         */
        function loadUserData() {
            userLearnOrder = JSON.parse(localStorage.getItem(LS_KEYS.ORDER) || '["f2l","oll","pll"]');
            learnedAlgs = JSON.parse(localStorage.getItem(LS_KEYS.LEARNED) || '[]');
        }

        /**
         * 5. Lógica de Navegación: Mostrar vista Diaria
         */
        function showDailyView() {
            currentView = 'daily';
            document.body.classList.remove('timer-view-active'); // (NUEVO)
            dailyView.classList.remove('hidden');
            browseView.classList.add('hidden');
            timerView.classList.add('hidden');
            
            navDaily.classList.add('tab-btn-active');
            navDaily.classList.remove('tab-btn-inactive');
            navBrowse.classList.add('tab-btn-inactive');
            navBrowse.classList.remove('tab-btn-active');
            navTimer.classList.add('tab-btn-inactive');
            navTimer.classList.remove('tab-btn-active');
            
            // Actualizar la vista diaria (por si se marcó algo como aprendido en "Explorar")
            initDailyView();
        }

        /**
         * 6. Lógica de Navegación: Mostrar vista Explorar
         */
        function showBrowseView() {
            currentView = 'browse';
            document.body.classList.remove('timer-view-active'); // (NUEVO)
            dailyView.classList.add('hidden');
            browseView.classList.remove('hidden');
            timerView.classList.add('hidden');

            navDaily.classList.add('tab-btn-inactive');
            navDaily.classList.remove('tab-btn-active');
            navBrowse.classList.add('tab-btn-active');
            navBrowse.classList.remove('tab-btn-inactive');
            navTimer.classList.add('tab-btn-inactive');
            navTimer.classList.remove('tab-btn-active');
            
            initBrowseView();
        }
        
        /**
         * (NUEVO) Lógica de Navegación: Mostrar vista Cronómetro
         */
        function showTimerView() {
            currentView = 'timer';
            document.body.classList.add('timer-view-active'); // (NUEVO)
            dailyView.classList.add('hidden');
            browseView.classList.add('hidden');
            timerView.classList.remove('hidden');

            navDaily.classList.add('tab-btn-inactive');
            navDaily.classList.remove('tab-btn-active');
            navBrowse.classList.add('tab-btn-inactive');
            navBrowse.classList.remove('tab-btn-active');
            navTimer.classList.add('tab-btn-active');
            navTimer.classList.remove('tab-btn-inactive');
            
            initTimerView();
        }

        /**
         * 7. Inicializa la vista Diaria (Dashboard y Algoritmos)
         */
        function initDailyView() {
            dailyLoading.classList.remove('hidden');
            dailyAlgsContainer.innerHTML = ''; // Limpiar algs anteriores
            
            updateDashboard(); // Actualizar estadísticas
            const dailyAlgs = getDailyAlgs();
            
            if (dailyAlgs.length > 0) {
                dailyAlgs.forEach(alg => {
                    const card = renderAlgCard(alg, alg.category);
                    dailyAlgsContainer.appendChild(card);
                });
                dailyLoading.classList.add('hidden');
            } else {
                dailyLoading.textContent = '¡Felicidades! Has aprendido todos los algoritmos.';
            }
        }

        /**
         * 8. Obtiene los 2 algoritmos del día (o los genera)
         */
        function getDailyAlgs() {
            const today = new Date().toISOString().split('T')[0];
            const lastVisit = localStorage.getItem(LS_KEYS.LAST_VISIT);
            const storedDailyAlgs = JSON.parse(localStorage.getItem(LS_KEYS.DAILY) || '[]');

            if (lastVisit === today && storedDailyAlgs.length > 0) {
                // Es el mismo día, devolver los algs guardados
                return storedDailyAlgs;
            }
            
            // Es un nuevo día o no hay algs guardados. Generar nuevos.
            localStorage.setItem(LS_KEYS.LAST_VISIT, today);
            
            const newDailyAlgs = [];
            
            // Recorrer el orden de aprendizaje preferido por el usuario
            for (const category of userLearnOrder) {
                if (!allData[category]) continue;
                
                for (const alg of allData[category]) {
                    if (newDailyAlgs.length >= 2) break; // Ya tenemos 2
                    
                    if (!learnedAlgs.includes(alg.id)) {
                        alg.category = category; // Añadir la categoría para el renderizado
                        newDailyAlgs.push(alg);
                    }
                }
                if (newDailyAlgs.length >= 2) break;
            }
            
            // Guardar estos 2 algs para el resto del día
            localStorage.setItem(LS_KEYS.DAILY, JSON.stringify(newDailyAlgs));
            return newDailyAlgs;
        }

        /**
         * 9. (NUEVO) Actualiza el dashboard de progreso
         */
        function updateDashboard() {
            if (!allData.f2l) return; // Esperar a que los datos carguen

            const learnedCount = learnedAlgs.length;
            const totalPercent = totalAlgs > 0 ? (learnedCount / totalAlgs * 100).toFixed(0) : 0;
            
            let currentCategory = userLearnOrder[0];
            let currentCategoryTotal = allData[currentCategory].length;
            let currentCategoryLearned = 0;
            
            for (const alg of allData[currentCategory]) {
                if (learnedAlgs.includes(alg.id)) {
                    currentCategoryLearned++;
                }
            }
            
            // Si el set actual está completo, pasar al siguiente
            if (currentCategoryLearned === currentCategoryTotal && userLearnOrder.length > 1) {
                currentCategory = userLearnOrder[1];
                currentCategoryTotal = allData[currentCategory].length;
                currentCategoryLearned = 0;
                for (const alg of allData[currentCategory]) {
                    if (learnedAlgs.includes(alg.id)) {
                        currentCategoryLearned++;
                    }
                }
            }
            // Si el segundo también está completo... etc.
            if (currentCategoryLearned === currentCategoryTotal && userLearnOrder.length > 2) {
                currentCategory = userLearnOrder[2];
                currentCategoryTotal = allData[currentCategory].length;
                currentCategoryLearned = 0;
                for (const alg of allData[currentCategory]) {
                    if (learnedAlgs.includes(alg.id)) {
                        currentCategoryLearned++;
                    }
                }
            }
            
            const currentPercent = (currentCategoryLearned / currentCategoryTotal * 100).toFixed(0);
            
            dashboardStats.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Progreso Total -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-gray-200">Progreso Total</span>
                            <span class="text-xl font-bold text-cyan-400">${learnedCount} / ${totalAlgs}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-4" style="width: ${totalPercent}%"></div>
                        </div>
                    </div>
                    <!-- Progreso Set Actual -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-gray-200">Set Actual: <span class="uppercase font-bold">${currentCategory}</span></span>
                            <span class="text-xl font-bold text-cyan-400">${currentCategoryLearned} / ${currentCategoryTotal}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-4" style="width: ${currentPercent}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * 10. Inicializa la vista Explorar (Listeners de pestañas)
         */
        function initBrowseView() {
            browseTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    currentBrowseCategory = tab.dataset.category;
                    
                    // Actualizar estilos de pestañas
                    browseTabs.forEach(t => t.classList.add('tab-btn-inactive'));
                    tab.classList.remove('tab-btn-inactive');
                    tab.classList.add('tab-btn-active');
                    
                    renderBrowseCategory(currentBrowseCategory);
                });
            });
            
            // Activar la pestaña F2L por defecto (o la primera activa)
            const activeTab = document.querySelector('.tab-btn-browse.tab-btn-active') || document.getElementById('btn-browse-f2l');
            activeTab.click();
        }

        /**
         * 11. Renderiza todos los algs de una categoría en "Explorar"
         */
        function renderBrowseCategory(category) {
            browseLoading.classList.add('hidden');
            browseContentContainer.innerHTML = ''; // Limpiar
            
            const algs = allData[category];
            if (!algs) {
                browseLoading.textContent = `No se encontraron algoritmos para ${category}.`;
                browseLoading.classList.remove('hidden');
                return;
            }
            
            algs.forEach(alg => {
                const card = renderAlgCard(alg, category);
                browseContentContainer.appendChild(card);
            });
        }

        /**
         * 12. CREA LA TARJETA HTML para un algoritmo (Usado por ambas vistas)
         * (ACTUALIZADO: Se AÑADIERON controles al visor)
         */
        function renderAlgCard(alg, category) {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 flex flex-col';
            card.dataset.algId = alg.id;

            const stickering = category.toUpperCase();
            const setupHtml = alg.setup ? `setup="${alg.setup}"` : '';
            const isLearned = learnedAlgs.includes(alg.id);
            const knowItBtnState = isLearned 
                ? 'bg-green-600 text-white shadow-none' 
                : 'bg-gray-700 text-gray-300 hover:bg-gray-600';
            const knowItIcon = isLearned ? ICON_CHECK : ICON_KNOW_IT;
            
            card.innerHTML = `
                <div class="w-full max-w-sm mx-auto mb-6">
                    <twisty-player
                        class="alg-player"
                        ${setupHtml}
                        alg="${alg.alg}"
                        control-panel="normal" <!-- (ACTUALIZADO) -->
                        experimental-stickering="${stickering}"
                        background="none"
                    ></twisty-player>
                </div>
                
                <div class="flex-grow">
                    <h3 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">${alg.name} (${alg.id})</h3>
                    <p class="text-lg font-mono text-cyan-300 my-3 p-3 bg-gray-900 rounded-lg break-words">${alg.alg}</p>
                    ${alg.setup ? `<p class="text-sm font-mono text-yellow-400 my-2 p-2 bg-gray-900 rounded-lg break-words">Setup: ${alg.setup}</p>` : ''}
                    <p class="text-gray-300 italic mt-2">${alg.trick}</p>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mt-6"> <!-- Layout actualizado a 1 columna -->
                    <button class="btn-know-it tab-btn-base ${knowItBtnState}" ${isLearned ? 'disabled' : ''}>
                        ${knowItIcon}
                    </button>
                    <!-- Botón de tutorial eliminado -->
                </div>
            `;
            
            // Añadir Listeners
            const knowItButton = card.querySelector('.btn-know-it');
            knowItButton.addEventListener('click', () => markAsLearned(alg.id, knowItButton));
            
            return card;
        }

        /**
         * 13. Marca un algoritmo como "aprendido"
         */
        function markAsLearned(algId, button) {
            if (learnedAlgs.includes(algId)) return; // Ya aprendido
            
            learnedAlgs.push(algId);
            localStorage.setItem(LS_KEYS.LEARNED, JSON.stringify(learnedAlgs));
            
            // Actualizar UI del botón
            button.innerHTML = ICON_CHECK;
            button.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
            button.classList.add('bg-green-600', 'text-white');
            button.disabled = true;
            
            // Actualizar el dashboard en tiempo real
            updateDashboard();
        }

        // === (NUEVO) SECCIÓN DEL CRONÓMETRO (LÓGICA ACTUALIZADA) ===

        /**
         * 14. Inicializa la vista del Cronómetro
         */
        function initTimerView() {
            loadSolves();
            renderStats();
            deleteSolvesBtn.onclick = deleteAllSolves;
            timerDisplay.textContent = "0.00";
            timerDisplay.classList.remove('text-green-500', 'text-cyan-400');
            timerDisplay.classList.add('text-gray-100');
            
            // (NUEVO) Listeners para los pulsadores táctiles/mouse
            // Mousedown/Touchstart
            btnTimerLeft.addEventListener('mousedown', () => onThumbDown('left'));
            btnTimerLeft.addEventListener('touchstart', (e) => { e.preventDefault(); onThumbDown('left'); });
            btnTimerRight.addEventListener('mousedown', () => onThumbDown('right'));
            btnTimerRight.addEventListener('touchstart', (e) => { e.preventDefault(); onThumbDown('right'); });
            
            // Mouseup/Touchend
            btnTimerLeft.addEventListener('mouseup', () => onThumbUp('left'));
            btnTimerLeft.addEventListener('touchend', (e) => { e.preventDefault(); onThumbUp('left'); });
            btnTimerRight.addEventListener('mouseup', () => onThumbUp('right'));
            btnTimerRight.addEventListener('touchend', (e) => { e.preventDefault(); onThumbUp('right'); });
        }

        /**
         * 15. Maneja el evento de presionar tecla
         */
        function handleTimerKeydown(e) {
            if (currentView !== 'timer') return; // Solo funciona en la vista de timer
            
            // Si el timer está corriendo, CUALQUIER tecla lo para
            if (timerRunning) {
                e.preventDefault();
                stopTimer();
                return; 
            } 
            
            // Si es la barra espaciadora
            if (e.code === 'Space' && !timerRunning) {
                e.preventDefault();
                onThumbDown('space'); // Usar el handler unificado
            }
        }

        /**
         * 16. Maneja el evento de soltar tecla
         */
        function handleTimerKeyup(e) {
            if (currentView !== 'timer') return;
            
            // Si es la barra espaciadora
            if (e.code === 'Space') {
                e.preventDefault();
                onThumbUp('space'); // Usar el handler unificado
            }
        }
        
        /**
         * (NUEVO) Handler unificado para "botón presionado"
         */
        function onThumbDown(side) {
            if (side === 'left') leftThumbDown = true;
            if (side === 'right') rightThumbDown = true;
            if (side === 'space') { // La barra espaciadora cuenta como ambos
                leftThumbDown = true;
                rightThumbDown = true;
            }

            // Si el timer está corriendo, parar inmediatamente
            if (timerRunning) {
                stopTimer();
                return;
            }
            
            // Si ambos están presionados y no está listo, ponerlo listo
            if (leftThumbDown && rightThumbDown && !timerReady) {
                prepareTimer();
            }
        }
        
        /**
         * (NUEVO) Handler unificado para "botón soltado"
         */
        function onThumbUp(side) {
            // Si el timer estaba listo (verde), empezar
            if (timerReady) {
                startTimer();
                timerReady = false; // El timer ya no está listo, está corriendo
            }
            
            if (side === 'left') leftThumbDown = false;
            if (side === 'right') rightThumbDown = false;
            if (side === 'space') { // La barra espaciadora suelta ambos
                leftThumbDown = false;
                rightThumbDown = false;
            }
        }

        /**
         * 17. Pone el timer en estado "listo" (verde)
         */
        function prepareTimer() {
            timerReady = true;
            timerDisplay.textContent = "0.00";
            timerDisplay.classList.add('text-green-500');
            timerDisplay.classList.remove('text-gray-100', 'text-cyan-400');
        }

        /**
         * 18. Inicia el conteo del timer
         */
        function startTimer() {
            timerReady = false;
            timerRunning = true;
            timerStartTime = Date.now();
            
            timerDisplay.classList.add('text-cyan-400');
            timerDisplay.classList.remove('text-gray-100', 'text-green-500');

            // Bucle de actualización
            timerInterval = setInterval(() => {
                const elapsedTime = (Date.now() - timerStartTime) / 1000;
                timerDisplay.textContent = elapsedTime.toFixed(2);
            }, 10); // Actualiza cada 10ms (centésimas)
        }

        /**
         * 19. Detiene el timer y guarda el tiempo
         */
        function stopTimer() {
            clearInterval(timerInterval);
            timerRunning = false;
            timerReady = false; // (NUEVO) Resetea estados
            leftThumbDown = false;
            rightThumbDown = false;
            
            const finalTime = (Date.now() - timerStartTime) / 1000;
            timerDisplay.textContent = finalTime.toFixed(2);
            timerDisplay.classList.add('text-gray-100');
            timerDisplay.classList.remove('text-green-500', 'text-cyan-400');
            
            addSolve(finalTime);
        }

        /**
         * 20. Carga los tiempos desde localStorage
         */
        function loadSolves() {
            solvesList = JSON.parse(localStorage.getItem(LS_KEYS.SOLVES) || '[]');
        }

        /**
         * 21. Añade un tiempo a la lista y la guarda
         */
        function addSolve(time) {
            solvesList.push(time);
            localStorage.setItem(LS_KEYS.SOLVES, JSON.stringify(solvesList));
            renderStats(); // Actualiza la UI
        }

        /**
         * 22. Borra todos los tiempos
         */
        function deleteAllSolves() {
            solvesList = [];
            localStorage.removeItem(LS_KEYS.SOLVES);
            renderStats(); // Actualiza la UI
        }
        
        /**
         * 23. Renderiza la lista de tiempos y las estadísticas
         */
        function renderStats() {
            // Renderizar lista de tiempos
            solvesListContainer.innerHTML = solvesList.map(time => 
                `<span class="w-16 text-right">${time.toFixed(2)}</span>`
            ).join('');
            // Scroll al fondo
            solvesListContainer.scrollTop = solvesListContainer.scrollHeight;

            // Calcular y renderizar estadísticas
            const count = solvesList.length;
            if (count === 0) {
                statsContainer.innerHTML = `
                    <div class="col-span-2 text-center text-gray-400">Presiona espacio o los pulsadores para empezar.</div>
                `;
                return;
            }

            const best = Math.min(...solvesList);
            const worst = Math.max(...solvesList);
            const ao5 = calculateAverage(5);
            const ao12 = calculateAverage(12);
            
            statsContainer.innerHTML = `
                ${renderStatCard('Mejor', best)}
                ${renderStatCard('Peor', worst)}
                ${renderStatCard('Media de 5', ao5)}
                ${renderStatCard('Media de 12', ao12)}
            `;
        }
        
        /**
         * 24. Helper para calcular media (Ao5, Ao12)
         */
        function calculateAverage(n) {
            if (solvesList.length < n) return 'N/A';
            
            // Tomar los últimos n tiempos
            const lastN = solvesList.slice(-n);
            
            // Ordenar para encontrar el mejor y peor
            lastN.sort((a, b) => a - b);
            
            // Quitar el mejor (primero) y el peor (último)
            const trimmedList = lastN.slice(1, -1);
            
            // Calcular la media
            const sum = trimmedList.reduce((acc, time) => acc + time, 0);
            const avg = sum / trimmedList.length;
            
            return avg.toFixed(2);
        }
        
        /**
         * 25. Helper para renderizar una tarjeta de estadística
         */
        function renderStatCard(label, value) {
            return `
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <div class="text-sm text-gray-400 uppercase">${label}</div>
                    <div class="text-2xl font-bold text-cyan-400">${value}</div>
                </div>
            `;
        }

    </script>
</body>
</html>
